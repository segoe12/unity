<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no">

<title>Unity WebAR</title>

<link rel="stylesheet" href="TemplateData/style.css">

<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: black;
}
#unity-canvas, #video-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
#video-canvas {
    z-index: 0;
}
#unity-canvas {
    z-index: 1;
    background: transparent;
}
.ctaDiv {
    position: absolute;
    inset: 0;
    background: #000a;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}
</style>
</head>

<body>

<!-- VIDEO -->
<video id="webcam-video" autoplay playsinline muted style="display:none"></video>
<canvas id="video-canvas"></canvas>

<!-- UNITY -->
<canvas id="unity-canvas"></canvas>

<!-- UI -->
<div id="startARDiv" class="ctaDiv">
    <button onclick="StartAR()">START AR</button>
</div>

<div id="errorDiv" class="ctaDiv" style="display:none">
    <p id="errorText"></p>
</div>

<!-- REQUIRED LIBS -->
<script src="opencv.js"></script>
<script src="arcamera.js"></script>
<script src="itracker.js"></script>
<script src="Build/www.loader.js"></script>

<script>
let unityInstance;
let arCamera;
let iTracker;

window.unityFacingMode = "environment";

window.WEBCAM_SETTINGS = {
    video: { facingMode: unityFacingMode },
    audio: false
};

function ShowError(msg){
    document.getElementById("errorDiv").style.display = "flex";
    document.getElementById("errorText").innerText = msg;
}

async function initializeAR(){
    const unityCanvas = document.getElementById("unity-canvas");
    const videoCanvas = document.getElementById("video-canvas");

    arCamera = new ARCamera(unityCanvas, videoCanvas);
    iTracker = new ImageTracker(arCamera);

    try {
        await iTracker.initialize();
        console.log("ImageTracker initialized");
    }
    catch (error){
        console.error(error);
        ShowError("ImageTracker init failed (OpenCV?)");
        return;
    }
}

async function RequestWebcam(){
    try {
        window.webcamStream = await navigator.mediaDevices.getUserMedia(WEBCAM_SETTINGS);
        console.log("Camera permission granted");
    }
    catch(err){
        console.error(err);
        ShowError("Camera permission denied");
    }
}

async function StartWebcam(){
    const video = document.getElementById("webcam-video");
    video.srcObject = webcamStream;

    try {
        await arCamera.startWebcam(video);
        unityInstance.SendMessage("ARCamera", "OnStartWebcamSuccess");
        console.log("Webcam started");
    }
    catch(err){
        console.error(err);
        unityInstance.SendMessage("ARCamera", "OnStartWebcamFail");
    }
}

async function StartAR(){
    document.getElementById("startARDiv").style.display = "none";

    await initializeAR();
    await RequestWebcam();

    unityInstance = await createUnityInstance(
        document.getElementById("unity-canvas"),
        {
            dataUrl: "Build/www.data",
            frameworkUrl: "Build/www.framework.js",
            codeUrl: "Build/www.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "WebAR",
            productVersion: "0.1"
        }
    );

    StartWebcam();
}
</script>

</body>
</html>
